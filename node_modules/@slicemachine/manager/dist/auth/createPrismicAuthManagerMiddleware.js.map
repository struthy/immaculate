{"version":3,"file":"createPrismicAuthManagerMiddleware.js","sources":["../../../src/auth/createPrismicAuthManagerMiddleware.ts"],"sourcesContent":["import * as t from \"io-ts\";\nimport {\n\tcreateEvent,\n\tcreateRouter,\n\tdefineNodeMiddleware,\n\teventHandler,\n\tNodeMiddleware,\n\treadBody,\n} from \"h3\";\n\nimport { decode } from \"../lib/decode\";\n\nimport { PrismicAuthManager } from \"./PrismicAuthManager\";\n\nconst PrismicAuthResponse = t.type({\n\temail: t.string,\n\tcookies: t.array(t.string),\n});\ntype PrismicAuthResponse = t.TypeOf<typeof PrismicAuthResponse>;\n\nexport type PrismicAuthCheckStatusResponse =\n\t| {\n\t\t\tstatus: \"ok\";\n\t\t\tshortId: string;\n\t\t\tintercomHash: string;\n\t  }\n\t| {\n\t\t\tstatus: \"pending\";\n\t  };\n\nexport type CreatePrismicAuthManagerMiddlewareArgs = {\n\tprismicAuthManager: PrismicAuthManager;\n\tonLoginCallback?: () => void | Promise<void>;\n};\n\nexport const createPrismicAuthManagerMiddleware = (\n\targs: CreatePrismicAuthManagerMiddlewareArgs,\n): NodeMiddleware => {\n\tconst router = createRouter();\n\n\t// Route called by the remote Prismic login page on successful login.\n\trouter.post(\n\t\t\"/\",\n\t\teventHandler(async (event) => {\n\t\t\tconst body = await readBody(event);\n\t\t\tconst { value, error } = decode(PrismicAuthResponse, body);\n\n\t\t\tif (error) {\n\t\t\t\tthrow new Error(`Invalid auth payload: ${error.errors.join(\", \")}`);\n\t\t\t}\n\n\t\t\tawait args.prismicAuthManager.login({\n\t\t\t\temail: value.email,\n\t\t\t\tcookies: value.cookies,\n\t\t\t});\n\n\t\t\tif (args.onLoginCallback) {\n\t\t\t\tawait args.onLoginCallback();\n\t\t\t}\n\n\t\t\treturn {};\n\t\t}),\n\t);\n\n\treturn defineNodeMiddleware(async (req, res) => {\n\t\tconst event = createEvent(req, res);\n\n\t\tawait router.handler(event);\n\n\t\tres.end();\n\t});\n};\n"],"names":[],"mappings":";;;AAcA,MAAM,sBAAsB,EAAE,KAAK;AAAA,EAClC,OAAO,EAAE;AAAA,EACT,SAAS,EAAE,MAAM,EAAE,MAAM;AACzB,CAAA;AAkBY,MAAA,qCAAqC,CACjD,SACmB;AACnB,QAAM,SAAS;AAGf,SAAO,KACN,KACA,aAAa,OAAO,UAAS;AACtB,UAAA,OAAO,MAAM,SAAS,KAAK;AACjC,UAAM,EAAE,OAAO,MAAA,IAAU,OAAO,qBAAqB,IAAI;AAEzD,QAAI,OAAO;AACV,YAAM,IAAI,MAAM,yBAAyB,MAAM,OAAO,KAAK,IAAI,GAAG;AAAA,IAClE;AAEK,UAAA,KAAK,mBAAmB,MAAM;AAAA,MACnC,OAAO,MAAM;AAAA,MACb,SAAS,MAAM;AAAA,IAAA,CACf;AAED,QAAI,KAAK,iBAAiB;AACzB,YAAM,KAAK;IACX;AAED,WAAO;EACP,CAAA,CAAC;AAGI,SAAA,qBAAqB,OAAO,KAAK,QAAO;AACxC,UAAA,QAAQ,YAAY,KAAK,GAAG;AAE5B,UAAA,OAAO,QAAQ,KAAK;AAE1B,QAAI,IAAG;AAAA,EAAA,CACP;AACF;"}