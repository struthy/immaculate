{"version":3,"file":"client.cjs","sources":["../../../../../../../../../node_modules/@amplitude/experiment-node-server/dist/src/remote/client.js"],"sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.ExperimentClient = exports.RemoteEvaluationClient = void 0;\nconst experiment_core_1 = require(\"@amplitude/experiment-core\");\nconst version_1 = require(\"../../gen/version\");\nconst http_1 = require(\"../transport/http\");\nconst config_1 = require(\"../types/config\");\nconst time_1 = require(\"../util/time\");\nconst variant_1 = require(\"../util/variant\");\n/**\n * Experiment client for fetching variants for a user remotely.\n * @category Core Usage\n */\nclass RemoteEvaluationClient {\n    /**\n     * Creates a new RemoteEvaluationClient instance.\n     *\n     * @param apiKey The environment API Key\n     * @param config See {@link ExperimentConfig} for config options\n     */\n    constructor(apiKey, config) {\n        var _a;\n        this.apiKey = apiKey;\n        this.config = Object.assign(Object.assign({}, config_1.RemoteEvaluationDefaults), config);\n        this.evaluationApi = new experiment_core_1.SdkEvaluationApi(apiKey, this.config.serverUrl, new http_1.WrapperClient(new http_1.FetchHttpClient((_a = this.config) === null || _a === void 0 ? void 0 : _a.httpAgent)));\n    }\n    /**\n     * Fetch remote evaluated variants for a user. This function can\n     * automatically retry the request on failure (if configured), and will\n     * throw the original error if all retries fail.\n     *\n     * Unlike {@link fetch}, this function returns a default variant object\n     * if the flag or experiment was evaluated, but the user was not assigned a\n     * variant (i.e. 'off').\n     *\n     * @param user The user to fetch variants for.\n     * @param options Options to configure the fetch request.\n     */\n    fetchV2(user, options) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!this.apiKey) {\n                throw Error('Experiment API key is empty');\n            }\n            this.debug('[Experiment] Fetching variants for user: ', user);\n            try {\n                return yield this.doFetch(user, this.config.fetchTimeoutMillis, options);\n            }\n            catch (e) {\n                console.error('[Experiment] Fetch failed: ', e);\n                try {\n                    return yield this.retryFetch(user, options);\n                }\n                catch (e) {\n                    console.error(e);\n                }\n                throw e;\n            }\n        });\n    }\n    /**\n     * Fetch all variants for a user.\n     *\n     * This method will automatically retry if configured (default).\n     *\n     * @param user The {@link ExperimentUser} context\n     * @param options The {@link FetchOptions} for this specific fetch request.\n     * @return The {@link Variants} for the user on success, empty\n     * {@link Variants} on error.\n     * @deprecated use fetchV2 instead\n     */\n    fetch(user, options) {\n        return __awaiter(this, void 0, void 0, function* () {\n            try {\n                const results = yield this.fetchV2(user, options);\n                return (0, variant_1.filterDefaultVariants)(results);\n            }\n            catch (e) {\n                console.error('[Experiment] Failed to fetch variants: ', e);\n                return {};\n            }\n        });\n    }\n    doFetch(user, timeoutMillis, options) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const userContext = this.addContext(user || {});\n            const results = yield this.evaluationApi.getVariants(userContext, {\n                flagKeys: options === null || options === void 0 ? void 0 : options.flagKeys,\n                timeoutMillis: timeoutMillis,\n            });\n            this.debug('[Experiment] Fetched variants: ', results);\n            return (0, variant_1.evaluationVariantsToVariants)(results);\n        });\n    }\n    retryFetch(user, options) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (this.config.fetchRetries == 0) {\n                return {};\n            }\n            this.debug('[Experiment] Retrying fetch');\n            let err = null;\n            let delayMillis = this.config.fetchRetryBackoffMinMillis;\n            for (let i = 0; i < this.config.fetchRetries; i++) {\n                yield (0, time_1.sleep)(delayMillis);\n                try {\n                    return yield this.doFetch(user, this.config.fetchRetryTimeoutMillis, options);\n                }\n                catch (e) {\n                    console.error('[Experiment] Retry falied: ', e);\n                    err = e;\n                }\n                delayMillis = Math.min(delayMillis * this.config.fetchRetryBackoffScalar, this.config.fetchRetryBackoffMaxMillis);\n            }\n            throw err;\n        });\n    }\n    addContext(user) {\n        return Object.assign({ library: `experiment-node-server/${version_1.version}` }, user);\n    }\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    debug(message, ...optionalParams) {\n        if (this.config.debug) {\n            console.debug(message, ...optionalParams);\n        }\n    }\n}\nexports.RemoteEvaluationClient = RemoteEvaluationClient;\n/**\n * @deprecated use {@link RemoteEvaluationClient}.\n */\nclass ExperimentClient extends RemoteEvaluationClient {\n    constructor(apiKey, config) {\n        super(apiKey, config);\n    }\n}\nexports.ExperimentClient = ExperimentClient;\n"],"names":["this","client","require$$0","require$$1","require$$2","require$$3","require$$4","require$$5","config","e"],"mappings":"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","x_google_ignoreList":[0]}