{"version":3,"file":"assignment-service.cjs","sources":["../../../../../../../../../node_modules/@amplitude/experiment-node-server/dist/src/assignment/assignment-service.js"],"sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.toEvent = exports.AmplitudeAssignmentService = exports.FLAG_TYPE_MUTUAL_EXCLUSION_GROUP = exports.DAY_MILLIS = void 0;\nconst hash_1 = require(\"../util/hash\");\nexports.DAY_MILLIS = 24 * 60 * 60 * 1000;\nexports.FLAG_TYPE_MUTUAL_EXCLUSION_GROUP = 'mutual-exclusion-group';\nclass AmplitudeAssignmentService {\n    constructor(amplitude, assignmentFilter) {\n        this.amplitude = amplitude;\n        this.assignmentFilter = assignmentFilter;\n    }\n    track(assignment) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (this.assignmentFilter.shouldTrack(assignment)) {\n                this.amplitude.logEvent((0, exports.toEvent)(assignment));\n            }\n        });\n    }\n}\nexports.AmplitudeAssignmentService = AmplitudeAssignmentService;\nconst toEvent = (assignment) => {\n    var _a, _b, _c, _d;\n    const event = {\n        event_type: '[Experiment] Assignment',\n        user_id: assignment.user.user_id,\n        device_id: assignment.user.device_id,\n        event_properties: {},\n        user_properties: {},\n    };\n    const set = {};\n    const unset = {};\n    for (const flagKey in assignment.results) {\n        const variant = assignment.results[flagKey];\n        if (!variant.key) {\n            continue;\n        }\n        const version = (_a = variant.metadata) === null || _a === void 0 ? void 0 : _a.flagVersion;\n        const segmentName = (_b = variant.metadata) === null || _b === void 0 ? void 0 : _b.segmentName;\n        const flagType = (_c = variant.metadata) === null || _c === void 0 ? void 0 : _c.flagType;\n        const isDefault = (_d = variant.metadata) === null || _d === void 0 ? void 0 : _d.default;\n        event.event_properties[`${flagKey}.variant`] = variant.key;\n        if (version && segmentName) {\n            event.event_properties[`${flagKey}.details`] = `v${version} rule:${segmentName}`;\n        }\n        if (flagType != exports.FLAG_TYPE_MUTUAL_EXCLUSION_GROUP) {\n            if (isDefault) {\n                unset[`[Experiment] ${flagKey}`] = '-';\n            }\n            else {\n                set[`[Experiment] ${flagKey}`] = variant.key;\n            }\n        }\n    }\n    event.user_properties['$set'] = set;\n    event.user_properties['$unset'] = unset;\n    event.insert_id = `${event.user_id} ${event.device_id} ${(0, hash_1.hashCode)(assignment.canonicalize())} ${Math.floor(assignment.timestamp / exports.DAY_MILLIS)}`;\n    return event;\n};\nexports.toEvent = toEvent;\n"],"names":["this","exports","require$$0"],"mappings":"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","x_google_ignoreList":[0]}