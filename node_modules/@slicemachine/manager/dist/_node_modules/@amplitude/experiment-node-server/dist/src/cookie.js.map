{"version":3,"file":"cookie.js","sources":["../../../../../../../../node_modules/@amplitude/experiment-node-server/dist/src/cookie.js"],"sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.AmplitudeCookie = void 0;\nconst logger_1 = require(\"./util/logger\");\n/**\n * This class provides utility functions for parsing and handling identity\n * from Amplitude cookies.\n */\nclass AmplitudeCookie {\n    /**\n     * @param amplitudeApiKey The Amplitude API Key\n     * @param newFormat True if the cookie is in the Browser SDK 2.0 format\n     * @returns The cookie name that Amplitude sets for the provided\n     * Amplitude API Key\n     */\n    static cookieName(amplitudeApiKey, newFormat = false) {\n        if (newFormat) {\n            if ((amplitudeApiKey === null || amplitudeApiKey === void 0 ? void 0 : amplitudeApiKey.length) < 10) {\n                throw Error('Invalid Amplitude API Key');\n            }\n            else {\n                return 'AMP_' + amplitudeApiKey.substring(0, 10);\n            }\n        }\n        if ((amplitudeApiKey === null || amplitudeApiKey === void 0 ? void 0 : amplitudeApiKey.length) < 6) {\n            throw Error('Invalid Amplitude API Key');\n        }\n        return 'amp_' + amplitudeApiKey.substring(0, 6);\n    }\n    /**\n     * @param amplitudeCookie A string from the amplitude cookie\n     * @param newFormat True if the cookie is in the Browser SDK 2.0 format\n     * @returns a ExperimentUser context containing a device_id and user_id\n     * (if available)\n     */\n    static parse(amplitudeCookie, newFormat = false) {\n        if (newFormat) {\n            const decoding = Buffer.from(amplitudeCookie, 'base64').toString('utf-8');\n            try {\n                const userSession = JSON.parse(decodeURIComponent(decoding));\n                return {\n                    device_id: userSession.deviceId,\n                    user_id: userSession.userId,\n                };\n            }\n            catch (e) {\n                const logger = new logger_1.ConsoleLogger(true);\n                logger.error(`Error parsing the Amplitude cookie: ${e.message}`);\n                return {};\n            }\n        }\n        const values = amplitudeCookie.split('.');\n        let user_id = undefined;\n        if (values[1]) {\n            try {\n                user_id = Buffer.from(values[1], 'base64').toString('utf-8');\n            }\n            catch (e) {\n                user_id = undefined;\n            }\n        }\n        return {\n            device_id: values[0],\n            user_id,\n        };\n    }\n    /**\n     * Generates a cookie string to set for the Amplitude Javascript SDK\n     * @param deviceId A device id to set\n     * @param newFormat True if the cookie is in the Browser SDK 2.0 format\n     * @returns A cookie string to set for the Amplitude Javascript SDK to read\n     */\n    static generate(deviceId, newFormat = false) {\n        if (!newFormat) {\n            return deviceId + '..........';\n        }\n        const userSessionHash = {\n            deviceId: deviceId,\n        };\n        const json_data = JSON.stringify(userSessionHash);\n        const encoded_json = encodeURIComponent(json_data);\n        const base64Encoded = Buffer.from(encoded_json).toString('base64');\n        return base64Encoded;\n    }\n}\nexports.AmplitudeCookie = AmplitudeCookie;\n"],"names":["require$$0","logger"],"mappings":";;;AACA,OAAO,eAAe,QAAS,cAAc,EAAE,OAAO,KAAI,CAAE;AACrC,OAAA,kBAAG;AAC1B,MAAM,WAAWA;AAKjB,MAAM,gBAAgB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOlB,OAAO,WAAW,iBAAiB,YAAY,OAAO;AAClD,QAAI,WAAW;AACX,WAAK,oBAAoB,QAAQ,oBAAoB,SAAS,SAAS,gBAAgB,UAAU,IAAI;AACjG,cAAM,MAAM,2BAA2B;AAAA,MAC1C,OACI;AACD,eAAO,SAAS,gBAAgB,UAAU,GAAG,EAAE;AAAA,MAClD;AAAA,IACJ;AACD,SAAK,oBAAoB,QAAQ,oBAAoB,SAAS,SAAS,gBAAgB,UAAU,GAAG;AAChG,YAAM,MAAM,2BAA2B;AAAA,IAC1C;AACD,WAAO,SAAS,gBAAgB,UAAU,GAAG,CAAC;AAAA,EACjD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOD,OAAO,MAAM,iBAAiB,YAAY,OAAO;AAC7C,QAAI,WAAW;AACX,YAAM,WAAW,OAAO,KAAK,iBAAiB,QAAQ,EAAE,SAAS,OAAO;AACxE,UAAI;AACA,cAAM,cAAc,KAAK,MAAM,mBAAmB,QAAQ,CAAC;AAC3D,eAAO;AAAA,UACH,WAAW,YAAY;AAAA,UACvB,SAAS,YAAY;AAAA,QACzC;AAAA,MACa,SACM,GAAP;AACI,cAAMC,UAAS,IAAI,SAAS,cAAc,IAAI;AAC9C,QAAAA,QAAO,MAAM,uCAAuC,EAAE,SAAS;AAC/D,eAAO;MACV;AAAA,IACJ;AACD,UAAM,SAAS,gBAAgB,MAAM,GAAG;AACxC,QAAI,UAAU;AACd,QAAI,OAAO,CAAC,GAAG;AACX,UAAI;AACA,kBAAU,OAAO,KAAK,OAAO,CAAC,GAAG,QAAQ,EAAE,SAAS,OAAO;AAAA,MAC9D,SACM,GAAP;AACI,kBAAU;AAAA,MACb;AAAA,IACJ;AACD,WAAO;AAAA,MACH,WAAW,OAAO,CAAC;AAAA,MACnB;AAAA,IACZ;AAAA,EACK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAOD,OAAO,SAAS,UAAU,YAAY,OAAO;AACzC,QAAI,CAAC,WAAW;AACZ,aAAO,WAAW;AAAA,IACrB;AACD,UAAM,kBAAkB;AAAA,MACpB;AAAA,IACZ;AACQ,UAAM,YAAY,KAAK,UAAU,eAAe;AAChD,UAAM,eAAe,mBAAmB,SAAS;AACjD,UAAM,gBAAgB,OAAO,KAAK,YAAY,EAAE,SAAS,QAAQ;AACjE,WAAO;AAAA,EACV;AACL;AACA,OAAA,kBAA0B;","x_google_ignoreList":[0]}