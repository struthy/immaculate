{"version":3,"file":"timeline.cjs","sources":["../../../../../../../../node_modules/@amplitude/analytics-core/lib/esm/timeline.js"],"sourcesContent":["import { __assign, __awaiter, __generator, __read, __values } from \"tslib\";\nimport { PluginType, } from '@amplitude/analytics-types';\nimport { buildResult } from './utils/result-builder';\nvar Timeline = /** @class */ (function () {\n    function Timeline(client) {\n        this.client = client;\n        this.queue = [];\n        // Flag to guarantee one schedule apply is running\n        this.applying = false;\n        // Flag indicates whether timeline is ready to process event\n        // Events collected before timeline is ready will stay in the queue to be processed later\n        this.plugins = [];\n    }\n    Timeline.prototype.register = function (plugin, config) {\n        return __awaiter(this, void 0, void 0, function () {\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, plugin.setup(config, this.client)];\n                    case 1:\n                        _a.sent();\n                        this.plugins.push(plugin);\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Timeline.prototype.deregister = function (pluginName) {\n        var _a;\n        return __awaiter(this, void 0, void 0, function () {\n            var index, plugin;\n            return __generator(this, function (_b) {\n                switch (_b.label) {\n                    case 0:\n                        index = this.plugins.findIndex(function (plugin) { return plugin.name === pluginName; });\n                        plugin = this.plugins[index];\n                        this.plugins.splice(index, 1);\n                        return [4 /*yield*/, ((_a = plugin.teardown) === null || _a === void 0 ? void 0 : _a.call(plugin))];\n                    case 1:\n                        _b.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Timeline.prototype.reset = function (client) {\n        this.applying = false;\n        var plugins = this.plugins;\n        plugins.map(function (plugin) { var _a; return (_a = plugin.teardown) === null || _a === void 0 ? void 0 : _a.call(plugin); });\n        this.plugins = [];\n        this.client = client;\n    };\n    Timeline.prototype.push = function (event) {\n        var _this = this;\n        return new Promise(function (resolve) {\n            _this.queue.push([event, resolve]);\n            _this.scheduleApply(0);\n        });\n    };\n    Timeline.prototype.scheduleApply = function (timeout) {\n        var _this = this;\n        if (this.applying)\n            return;\n        this.applying = true;\n        setTimeout(function () {\n            void _this.apply(_this.queue.shift()).then(function () {\n                _this.applying = false;\n                if (_this.queue.length > 0) {\n                    _this.scheduleApply(0);\n                }\n            });\n        }, timeout);\n    };\n    Timeline.prototype.apply = function (item) {\n        return __awaiter(this, void 0, void 0, function () {\n            var _a, event, _b, resolve, before, before_1, before_1_1, plugin, e, e_1_1, enrichment, enrichment_1, enrichment_1_1, plugin, e, e_2_1, destination, executeDestinations;\n            var e_1, _c, e_2, _d;\n            return __generator(this, function (_e) {\n                switch (_e.label) {\n                    case 0:\n                        if (!item) {\n                            return [2 /*return*/];\n                        }\n                        _a = __read(item, 1), event = _a[0];\n                        _b = __read(item, 2), resolve = _b[1];\n                        before = this.plugins.filter(function (plugin) { return plugin.type === PluginType.BEFORE; });\n                        _e.label = 1;\n                    case 1:\n                        _e.trys.push([1, 6, 7, 8]);\n                        before_1 = __values(before), before_1_1 = before_1.next();\n                        _e.label = 2;\n                    case 2:\n                        if (!!before_1_1.done) return [3 /*break*/, 5];\n                        plugin = before_1_1.value;\n                        return [4 /*yield*/, plugin.execute(__assign({}, event))];\n                    case 3:\n                        e = _e.sent();\n                        if (e === null) {\n                            resolve({ event: event, code: 0, message: '' });\n                            return [2 /*return*/];\n                        }\n                        else {\n                            event = e;\n                        }\n                        _e.label = 4;\n                    case 4:\n                        before_1_1 = before_1.next();\n                        return [3 /*break*/, 2];\n                    case 5: return [3 /*break*/, 8];\n                    case 6:\n                        e_1_1 = _e.sent();\n                        e_1 = { error: e_1_1 };\n                        return [3 /*break*/, 8];\n                    case 7:\n                        try {\n                            if (before_1_1 && !before_1_1.done && (_c = before_1.return)) _c.call(before_1);\n                        }\n                        finally { if (e_1) throw e_1.error; }\n                        return [7 /*endfinally*/];\n                    case 8:\n                        enrichment = this.plugins.filter(function (plugin) { return plugin.type === PluginType.ENRICHMENT; });\n                        _e.label = 9;\n                    case 9:\n                        _e.trys.push([9, 14, 15, 16]);\n                        enrichment_1 = __values(enrichment), enrichment_1_1 = enrichment_1.next();\n                        _e.label = 10;\n                    case 10:\n                        if (!!enrichment_1_1.done) return [3 /*break*/, 13];\n                        plugin = enrichment_1_1.value;\n                        return [4 /*yield*/, plugin.execute(__assign({}, event))];\n                    case 11:\n                        e = _e.sent();\n                        if (e === null) {\n                            resolve({ event: event, code: 0, message: '' });\n                            return [2 /*return*/];\n                        }\n                        else {\n                            event = e;\n                        }\n                        _e.label = 12;\n                    case 12:\n                        enrichment_1_1 = enrichment_1.next();\n                        return [3 /*break*/, 10];\n                    case 13: return [3 /*break*/, 16];\n                    case 14:\n                        e_2_1 = _e.sent();\n                        e_2 = { error: e_2_1 };\n                        return [3 /*break*/, 16];\n                    case 15:\n                        try {\n                            if (enrichment_1_1 && !enrichment_1_1.done && (_d = enrichment_1.return)) _d.call(enrichment_1);\n                        }\n                        finally { if (e_2) throw e_2.error; }\n                        return [7 /*endfinally*/];\n                    case 16:\n                        destination = this.plugins.filter(function (plugin) { return plugin.type === PluginType.DESTINATION; });\n                        executeDestinations = destination.map(function (plugin) {\n                            var eventClone = __assign({}, event);\n                            return plugin.execute(eventClone).catch(function (e) { return buildResult(eventClone, 0, String(e)); });\n                        });\n                        void Promise.all(executeDestinations).then(function (_a) {\n                            var _b = __read(_a, 1), result = _b[0];\n                            resolve(result);\n                        });\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    Timeline.prototype.flush = function () {\n        return __awaiter(this, void 0, void 0, function () {\n            var queue, destination, executeDestinations;\n            var _this = this;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        queue = this.queue;\n                        this.queue = [];\n                        return [4 /*yield*/, Promise.all(queue.map(function (item) { return _this.apply(item); }))];\n                    case 1:\n                        _a.sent();\n                        destination = this.plugins.filter(function (plugin) { return plugin.type === PluginType.DESTINATION; });\n                        executeDestinations = destination.map(function (plugin) {\n                            return plugin.flush && plugin.flush();\n                        });\n                        return [4 /*yield*/, Promise.all(executeDestinations)];\n                    case 2:\n                        _a.sent();\n                        return [2 /*return*/];\n                }\n            });\n        });\n    };\n    return Timeline;\n}());\nexport { Timeline };\n//# sourceMappingURL=timeline.js.map"],"names":["Timeline","plugin","__awaiter","__generator","__read","PluginType","__values","__assign","e","buildResult","_a","_b"],"mappings":"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","x_google_ignoreList":[0]}