import { DEBUG_BUILD } from "./debug-build.js";
import { getGlobalSingleton } from "../../utils/esm/worldwide.js";
import { SyncPromise } from "../../utils/esm/syncpromise.js";
import { logger } from "../../utils/esm/logger.js";
import { isThenable } from "../../utils/esm/is.js";
function getGlobalEventProcessors() {
  return getGlobalSingleton("globalEventProcessors", () => []);
}
function addGlobalEventProcessor(callback) {
  getGlobalEventProcessors().push(callback);
}
function notifyEventProcessors(processors, event, hint, index = 0) {
  return new SyncPromise((resolve, reject) => {
    const processor = processors[index];
    if (event === null || typeof processor !== "function") {
      resolve(event);
    } else {
      const result = processor({ ...event }, hint);
      DEBUG_BUILD && processor.id && result === null && logger.log(`Event processor "${processor.id}" dropped event`);
      if (isThenable(result)) {
        void result.then((final) => notifyEventProcessors(processors, final, hint, index + 1).then(resolve)).then(null, reject);
      } else {
        void notifyEventProcessors(processors, result, hint, index + 1).then(resolve).then(null, reject);
      }
    }
  });
}
export {
  addGlobalEventProcessor,
  getGlobalEventProcessors,
  notifyEventProcessors
};
//# sourceMappingURL=eventProcessors.js.map
