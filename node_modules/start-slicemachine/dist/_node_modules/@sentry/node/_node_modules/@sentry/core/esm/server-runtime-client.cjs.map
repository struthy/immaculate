{"version":3,"file":"server-runtime-client.cjs","sources":["../../../../../../../../../../node_modules/@sentry/node/node_modules/@sentry/core/esm/server-runtime-client.js"],"sourcesContent":["import { resolvedSyncPromise, eventFromUnknownInput, eventFromMessage, logger, uuid4 } from '@sentry/utils';\nimport { BaseClient } from './baseclient.js';\nimport { createCheckInEnvelope } from './checkin.js';\nimport { DEBUG_BUILD } from './debug-build.js';\nimport { getClient } from './exports.js';\nimport { MetricsAggregator } from './metrics/aggregator.js';\nimport { SessionFlusher } from './sessionflusher.js';\nimport { addTracingExtensions } from './tracing/hubextensions.js';\nimport { spanToTraceContext } from './utils/spanUtils.js';\nimport { getRootSpan } from './utils/getRootSpan.js';\nimport './tracing/spanstatus.js';\nimport { getDynamicSamplingContextFromSpan, getDynamicSamplingContextFromClient } from './tracing/dynamicSamplingContext.js';\n\n/**\n * The Sentry Server Runtime Client SDK.\n */\nclass ServerRuntimeClient\n\n extends BaseClient {\n\n  /**\n   * Creates a new Edge SDK instance.\n   * @param options Configuration options for this SDK.\n   */\n   constructor(options) {\n    // Server clients always support tracing\n    addTracingExtensions();\n\n    super(options);\n\n    if (options._experiments && options._experiments['metricsAggregator']) {\n      this.metricsAggregator = new MetricsAggregator(this);\n    }\n  }\n\n  /**\n   * @inheritDoc\n   */\n   eventFromException(exception, hint) {\n    return resolvedSyncPromise(eventFromUnknownInput(getClient(), this._options.stackParser, exception, hint));\n  }\n\n  /**\n   * @inheritDoc\n   */\n   eventFromMessage(\n    message,\n    // eslint-disable-next-line deprecation/deprecation\n    level = 'info',\n    hint,\n  ) {\n    return resolvedSyncPromise(\n      eventFromMessage(this._options.stackParser, message, level, hint, this._options.attachStacktrace),\n    );\n  }\n\n  /**\n   * @inheritDoc\n   */\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/explicit-module-boundary-types\n   captureException(exception, hint, scope) {\n    // Check if the flag `autoSessionTracking` is enabled, and if `_sessionFlusher` exists because it is initialised only\n    // when the `requestHandler` middleware is used, and hence the expectation is to have SessionAggregates payload\n    // sent to the Server only when the `requestHandler` middleware is used\n    if (this._options.autoSessionTracking && this._sessionFlusher && scope) {\n      const requestSession = scope.getRequestSession();\n\n      // Necessary checks to ensure this is code block is executed only within a request\n      // Should override the status only if `requestSession.status` is `Ok`, which is its initial stage\n      if (requestSession && requestSession.status === 'ok') {\n        requestSession.status = 'errored';\n      }\n    }\n\n    return super.captureException(exception, hint, scope);\n  }\n\n  /**\n   * @inheritDoc\n   */\n   captureEvent(event, hint, scope) {\n    // Check if the flag `autoSessionTracking` is enabled, and if `_sessionFlusher` exists because it is initialised only\n    // when the `requestHandler` middleware is used, and hence the expectation is to have SessionAggregates payload\n    // sent to the Server only when the `requestHandler` middleware is used\n    if (this._options.autoSessionTracking && this._sessionFlusher && scope) {\n      const eventType = event.type || 'exception';\n      const isException =\n        eventType === 'exception' && event.exception && event.exception.values && event.exception.values.length > 0;\n\n      // If the event is of type Exception, then a request session should be captured\n      if (isException) {\n        const requestSession = scope.getRequestSession();\n\n        // Ensure that this is happening within the bounds of a request, and make sure not to override\n        // Session Status if Errored / Crashed\n        if (requestSession && requestSession.status === 'ok') {\n          requestSession.status = 'errored';\n        }\n      }\n    }\n\n    return super.captureEvent(event, hint, scope);\n  }\n\n  /**\n   *\n   * @inheritdoc\n   */\n   close(timeout) {\n    if (this._sessionFlusher) {\n      this._sessionFlusher.close();\n    }\n    return super.close(timeout);\n  }\n\n  /** Method that initialises an instance of SessionFlusher on Client */\n   initSessionFlusher() {\n    const { release, environment } = this._options;\n    if (!release) {\n      DEBUG_BUILD && logger.warn('Cannot initialise an instance of SessionFlusher if no release is provided!');\n    } else {\n      this._sessionFlusher = new SessionFlusher(this, {\n        release,\n        environment,\n      });\n    }\n  }\n\n  /**\n   * Create a cron monitor check in and send it to Sentry.\n   *\n   * @param checkIn An object that describes a check in.\n   * @param upsertMonitorConfig An optional object that describes a monitor config. Use this if you want\n   * to create a monitor automatically when sending a check in.\n   */\n   captureCheckIn(checkIn, monitorConfig, scope) {\n    const id = 'checkInId' in checkIn && checkIn.checkInId ? checkIn.checkInId : uuid4();\n    if (!this._isEnabled()) {\n      DEBUG_BUILD && logger.warn('SDK not enabled, will not capture checkin.');\n      return id;\n    }\n\n    const options = this.getOptions();\n    const { release, environment, tunnel } = options;\n\n    const serializedCheckIn = {\n      check_in_id: id,\n      monitor_slug: checkIn.monitorSlug,\n      status: checkIn.status,\n      release,\n      environment,\n    };\n\n    if ('duration' in checkIn) {\n      serializedCheckIn.duration = checkIn.duration;\n    }\n\n    if (monitorConfig) {\n      serializedCheckIn.monitor_config = {\n        schedule: monitorConfig.schedule,\n        checkin_margin: monitorConfig.checkinMargin,\n        max_runtime: monitorConfig.maxRuntime,\n        timezone: monitorConfig.timezone,\n      };\n    }\n\n    const [dynamicSamplingContext, traceContext] = this._getTraceInfoFromScope(scope);\n    if (traceContext) {\n      serializedCheckIn.contexts = {\n        trace: traceContext,\n      };\n    }\n\n    const envelope = createCheckInEnvelope(\n      serializedCheckIn,\n      dynamicSamplingContext,\n      this.getSdkMetadata(),\n      tunnel,\n      this.getDsn(),\n    );\n\n    DEBUG_BUILD && logger.info('Sending checkin:', checkIn.monitorSlug, checkIn.status);\n\n    // _sendEnvelope should not throw\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    this._sendEnvelope(envelope);\n\n    return id;\n  }\n\n  /**\n   * Method responsible for capturing/ending a request session by calling `incrementSessionStatusCount` to increment\n   * appropriate session aggregates bucket\n   */\n   _captureRequestSession() {\n    if (!this._sessionFlusher) {\n      DEBUG_BUILD && logger.warn('Discarded request mode session because autoSessionTracking option was disabled');\n    } else {\n      this._sessionFlusher.incrementSessionStatusCount();\n    }\n  }\n\n  /**\n   * @inheritDoc\n   */\n   _prepareEvent(\n    event,\n    hint,\n    scope,\n    isolationScope,\n  ) {\n    if (this._options.platform) {\n      event.platform = event.platform || this._options.platform;\n    }\n\n    if (this._options.runtime) {\n      event.contexts = {\n        ...event.contexts,\n        runtime: (event.contexts || {}).runtime || this._options.runtime,\n      };\n    }\n\n    if (this._options.serverName) {\n      event.server_name = event.server_name || this._options.serverName;\n    }\n\n    return super._prepareEvent(event, hint, scope, isolationScope);\n  }\n\n  /** Extract trace information from scope */\n   _getTraceInfoFromScope(\n    scope,\n  ) {\n    if (!scope) {\n      return [undefined, undefined];\n    }\n\n    // eslint-disable-next-line deprecation/deprecation\n    const span = scope.getSpan();\n    if (span) {\n      const samplingContext = getRootSpan(span) ? getDynamicSamplingContextFromSpan(span) : undefined;\n      return [samplingContext, spanToTraceContext(span)];\n    }\n\n    const { traceId, spanId, parentSpanId, dsc } = scope.getPropagationContext();\n    const traceContext = {\n      trace_id: traceId,\n      span_id: spanId,\n      parent_span_id: parentSpanId,\n    };\n    if (dsc) {\n      return [dsc, traceContext];\n    }\n\n    return [getDynamicSamplingContextFromClient(traceId, this, scope), traceContext];\n  }\n}\n\nexport { ServerRuntimeClient };\n//# sourceMappingURL=server-runtime-client.js.map\n"],"names":["BaseClient","addTracingExtensions","MetricsAggregator","resolvedSyncPromise","eventFromUnknownInput","getClient","eventFromMessage","DEBUG_BUILD","logger","SessionFlusher","uuid4","dynamicSamplingContext","createCheckInEnvelope","getRootSpan","getDynamicSamplingContextFromSpan","spanToTraceContext","getDynamicSamplingContextFromClient"],"mappings":"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","x_google_ignoreList":[0]}