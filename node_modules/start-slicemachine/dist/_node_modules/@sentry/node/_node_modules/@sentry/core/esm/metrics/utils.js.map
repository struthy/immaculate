{"version":3,"file":"utils.js","sources":["../../../../../../../../../../../node_modules/@sentry/node/node_modules/@sentry/core/esm/metrics/utils.js"],"sourcesContent":["import { dropUndefinedKeys } from '@sentry/utils';\n\n/**\n * Generate bucket key from metric properties.\n */\nfunction getBucketKey(\n  metricType,\n  name,\n  unit,\n  tags,\n) {\n  const stringifiedTags = Object.entries(dropUndefinedKeys(tags)).sort((a, b) => a[0].localeCompare(b[0]));\n  return `${metricType}${name}${unit}${stringifiedTags}`;\n}\n\n/* eslint-disable no-bitwise */\n/**\n * Simple hash function for strings.\n */\nfunction simpleHash(s) {\n  let rv = 0;\n  for (let i = 0; i < s.length; i++) {\n    const c = s.charCodeAt(i);\n    rv = (rv << 5) - rv + c;\n    rv &= rv;\n  }\n  return rv >>> 0;\n}\n/* eslint-enable no-bitwise */\n\n/**\n * Serialize metrics buckets into a string based on statsd format.\n *\n * Example of format:\n * metric.name@second:1:1.2|d|#a:value,b:anothervalue|T12345677\n * Segments:\n * name: metric.name\n * unit: second\n * value: [1, 1.2]\n * type of metric: d (distribution)\n * tags: { a: value, b: anothervalue }\n * timestamp: 12345677\n */\nfunction serializeMetricBuckets(metricBucketItems) {\n  let out = '';\n  for (const item of metricBucketItems) {\n    const tagEntries = Object.entries(item.tags);\n    const maybeTags = tagEntries.length > 0 ? `|#${tagEntries.map(([key, value]) => `${key}:${value}`).join(',')}` : '';\n    out += `${item.name}@${item.unit}:${item.metric}|${item.metricType}${maybeTags}|T${item.timestamp}\\n`;\n  }\n  return out;\n}\n\n/** Sanitizes units */\nfunction sanitizeUnit(unit) {\n  return unit.replace(/[^\\w]+/gi, '_');\n}\n\n/** Sanitizes metric keys */\nfunction sanitizeMetricKey(key) {\n  return key.replace(/[^\\w\\-.]+/gi, '_');\n}\n\nfunction sanitizeTagKey(key) {\n  return key.replace(/[^\\w\\-./]+/gi, '');\n}\n\nconst tagValueReplacements = [\n  ['\\n', '\\\\n'],\n  ['\\r', '\\\\r'],\n  ['\\t', '\\\\t'],\n  ['\\\\', '\\\\\\\\'],\n  ['|', '\\\\u{7c}'],\n  [',', '\\\\u{2c}'],\n];\n\nfunction getCharOrReplacement(input) {\n  for (const [search, replacement] of tagValueReplacements) {\n    if (input === search) {\n      return replacement;\n    }\n  }\n\n  return input;\n}\n\nfunction sanitizeTagValue(value) {\n  return [...value].reduce((acc, char) => acc + getCharOrReplacement(char), '');\n}\n\n/**\n * Sanitizes tags.\n */\nfunction sanitizeTags(unsanitizedTags) {\n  const tags = {};\n  for (const key in unsanitizedTags) {\n    if (Object.prototype.hasOwnProperty.call(unsanitizedTags, key)) {\n      const sanitizedKey = sanitizeTagKey(key);\n      tags[sanitizedKey] = sanitizeTagValue(String(unsanitizedTags[key]));\n    }\n  }\n  return tags;\n}\n\nexport { getBucketKey, sanitizeMetricKey, sanitizeTags, sanitizeUnit, serializeMetricBuckets, simpleHash };\n//# sourceMappingURL=utils.js.map\n"],"names":[],"mappings":";AAKA,SAAS,aACP,YACA,MACA,MACA,MACA;AACA,QAAM,kBAAkB,OAAO,QAAQ,kBAAkB,IAAI,CAAC,EAAE,KAAK,CAAC,GAAG,MAAM,EAAE,CAAC,EAAE,cAAc,EAAE,CAAC,CAAC,CAAC;AACvG,SAAO,GAAG,aAAa,OAAO,OAAO;AACvC;AAMA,SAAS,WAAW,GAAG;AACrB,MAAI,KAAK;AACT,WAAS,IAAI,GAAG,IAAI,EAAE,QAAQ,KAAK;AACjC,UAAM,IAAI,EAAE,WAAW,CAAC;AACxB,UAAM,MAAM,KAAK,KAAK;AACtB,UAAM;AAAA,EACP;AACD,SAAO,OAAO;AAChB;AAgBA,SAAS,uBAAuB,mBAAmB;AACjD,MAAI,MAAM;AACV,aAAW,QAAQ,mBAAmB;AACpC,UAAM,aAAa,OAAO,QAAQ,KAAK,IAAI;AAC3C,UAAM,YAAY,WAAW,SAAS,IAAI,KAAK,WAAW,IAAI,CAAC,CAAC,KAAK,KAAK,MAAM,GAAG,OAAO,OAAO,EAAE,KAAK,GAAG,MAAM;AACjH,WAAO,GAAG,KAAK,QAAQ,KAAK,QAAQ,KAAK,UAAU,KAAK,aAAa,cAAc,KAAK;AAAA;AAAA,EACzF;AACD,SAAO;AACT;AAGA,SAAS,aAAa,MAAM;AAC1B,SAAO,KAAK,QAAQ,YAAY,GAAG;AACrC;AAGA,SAAS,kBAAkB,KAAK;AAC9B,SAAO,IAAI,QAAQ,eAAe,GAAG;AACvC;AAEA,SAAS,eAAe,KAAK;AAC3B,SAAO,IAAI,QAAQ,gBAAgB,EAAE;AACvC;AAEA,MAAM,uBAAuB;AAAA,EAC3B,CAAC,MAAM,KAAK;AAAA,EACZ,CAAC,MAAM,KAAK;AAAA,EACZ,CAAC,KAAM,KAAK;AAAA,EACZ,CAAC,MAAM,MAAM;AAAA,EACb,CAAC,KAAK,SAAS;AAAA,EACf,CAAC,KAAK,SAAS;AACjB;AAEA,SAAS,qBAAqB,OAAO;AACnC,aAAW,CAAC,QAAQ,WAAW,KAAK,sBAAsB;AACxD,QAAI,UAAU,QAAQ;AACpB,aAAO;AAAA,IACR;AAAA,EACF;AAED,SAAO;AACT;AAEA,SAAS,iBAAiB,OAAO;AAC/B,SAAO,CAAC,GAAG,KAAK,EAAE,OAAO,CAAC,KAAK,SAAS,MAAM,qBAAqB,IAAI,GAAG,EAAE;AAC9E;AAKA,SAAS,aAAa,iBAAiB;AACrC,QAAM,OAAO,CAAA;AACb,aAAW,OAAO,iBAAiB;AACjC,QAAI,OAAO,UAAU,eAAe,KAAK,iBAAiB,GAAG,GAAG;AAC9D,YAAM,eAAe,eAAe,GAAG;AACvC,WAAK,YAAY,IAAI,iBAAiB,OAAO,gBAAgB,GAAG,CAAC,CAAC;AAAA,IACnE;AAAA,EACF;AACD,SAAO;AACT;","x_google_ignoreList":[0]}